
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Single-Cell Image Analysis Package">
      
      
        <meta name="author" content="Ajit Johnson Nirmal">
      
      
      
        <link rel="prev" href="../spatial_aggregate/">
      
      
        <link rel="next" href="../../pl/image_viewer/">
      
      <link rel="icon" href="../../../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.15">
    
    
      
        <title>spatial_similarity_search - scimap</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-22X9HCL4YP"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-22X9HCL4YP",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-22X9HCL4YP",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#scimap.tools._spatial_similarity_search" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="scimap" class="md-header__button md-logo" aria-label="scimap" data-md-component="logo">
      
  <img src="../../../assets/favicon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            scimap
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              spatial_similarity_search
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/ajitjohnson/scimap" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../../Getting%20Started/" class="md-tabs__link">
      Getting Started
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../../Tools%20Shortcut/" class="md-tabs__link">
      Tools Shortcut
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../pp/mcmicro_to_scimap/" class="md-tabs__link md-tabs__link--active">
        SCIMAP Functions
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../tutorials/1-scimap-tutorial-getting-started/" class="md-tabs__link">
        Tutorials
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="scimap" class="md-nav__button md-logo" aria-label="scimap" data-md-component="logo">
      
  <img src="../../../assets/favicon.png" alt="logo">

    </a>
    scimap
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ajitjohnson/scimap" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../Getting%20Started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../Tools%20Shortcut/" class="md-nav__link">
        Tools Shortcut
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          SCIMAP Functions
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          SCIMAP Functions
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
          Pre Processing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Pre Processing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pp/mcmicro_to_scimap/" class="md-nav__link">
        mcmicro_to_scimap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pp/rescale/" class="md-nav__link">
        rescale
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pp/combat/" class="md-nav__link">
        combat
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
          Tools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Tools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../phenotype_cells/" class="md-nav__link">
        phenotype_cells
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cluster/" class="md-nav__link">
        cluster
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../umap/" class="md-nav__link">
        umap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../foldchange/" class="md-nav__link">
        foldchange
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spatial_distance/" class="md-nav__link">
        spatial_distance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spatial_interaction/" class="md-nav__link">
        spatial_interaction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spatial_count/" class="md-nav__link">
        spatial_count
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spatial_lda/" class="md-nav__link">
        spatial_lda
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spatial_expression/" class="md-nav__link">
        spatial_expression
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spatial_cluster/" class="md-nav__link">
        spatial_cluster
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spatial_pscore/" class="md-nav__link">
        spatial_pscore
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spatial_aggregate/" class="md-nav__link">
        spatial_aggregate
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          spatial_similarity_search
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        spatial_similarity_search
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#scimap.tools._spatial_similarity_search" class="md-nav__link">
    scimap.tools._spatial_similarity_search
  </a>
  
    <nav class="md-nav" aria-label="scimap.tools._spatial_similarity_search">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scimap.tools._spatial_similarity_search--function" class="md-nav__link">
    Function
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scimap.tools._spatial_similarity_search.spatial_similarity_search" class="md-nav__link">
    spatial_similarity_search()
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
      
      
      
        <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
          Plotting Functions
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Plotting Functions
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/image_viewer/" class="md-nav__link">
        image_viewer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/addROI_image/" class="md-nav__link">
        addROI_image
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/gate_finder/" class="md-nav__link">
        gate_finder
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/distPlot/" class="md-nav__link">
        distPlot
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/densityPlot2D/" class="md-nav__link">
        densityPlot2D
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/cluster_plots/" class="md-nav__link">
        cluster_plots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/umap/" class="md-nav__link">
        umap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/foldchange/" class="md-nav__link">
        foldchange
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/spatial_scatterPlot/" class="md-nav__link">
        spatial_scatterPlot
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/spatial_distance/" class="md-nav__link">
        spatial_distance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/spatial_interaction/" class="md-nav__link">
        spatial_interaction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/spatial_pscore/" class="md-nav__link">
        spatial_pscore
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/stacked_barplot/" class="md-nav__link">
        stacked_barplot
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/pie/" class="md-nav__link">
        pie
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/voronoi/" class="md-nav__link">
        voronoi
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
          Helper Functions
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_4">
          <span class="md-nav__icon md-icon"></span>
          Helper Functions
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hl/classify/" class="md-nav__link">
        classify
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hl/rename/" class="md-nav__link">
        rename
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hl/addROI_omero/" class="md-nav__link">
        addROI_omero
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hl/dropFeatures/" class="md-nav__link">
        dropFeatures
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hl/animate/" class="md-nav__link">
        animate
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hl/scimap_to_csv/" class="md-nav__link">
        scimap_to_csv
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Tutorials
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/1-scimap-tutorial-getting-started/" class="md-nav__link">
        Getting Started with Scimap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/2-scimap-tutorial-cell-phenotyping/" class="md-nav__link">
        Cell-Phenotyping using Scimap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/3-Cell_Type_calling_and_adding_ROIs/" class="md-nav__link">
        Cell-Phenotyping and adding ROIs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/4-CellType_Proportion_Exploration/" class="md-nav__link">
        CellType Proportion Exploration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/5-Simple_Spatial_Analysis/" class="md-nav__link">
        Simple Spatial Analysis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/6_animate_with_scimap/" class="md-nav__link">
        Animate with scimap
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#scimap.tools._spatial_similarity_search" class="md-nav__link">
    scimap.tools._spatial_similarity_search
  </a>
  
    <nav class="md-nav" aria-label="scimap.tools._spatial_similarity_search">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scimap.tools._spatial_similarity_search--function" class="md-nav__link">
    Function
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scimap.tools._spatial_similarity_search.spatial_similarity_search" class="md-nav__link">
    spatial_similarity_search()
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>spatial_similarity_search</h1>

<div class="doc doc-object doc-module">


<a id="scimap.tools._spatial_similarity_search"></a>
  <div class="doc doc-contents first">
  
      <div class="admonition abstract">
<p class="admonition-title">Short Description</p>
<p><code>sm.tl.spatial_similarity_search</code>: The function allows users to identify regions within a image 
that are similar to a user defined region based on the underlying molecular profile.</p>
<p>The result is saved within <code>adata.obs</code>. The user can visualize the results on the image using
<code>sm.pl.image_viewer</code> and then modify the <code>similarity_threshold</code> parameter to attain the best redults. </p>
</div>
<h5 id="scimap.tools._spatial_similarity_search--function">Function</h5>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h4 id="scimap.tools._spatial_similarity_search.spatial_similarity_search" class="doc doc-heading">
<code class="highlight language-python"><span class="n">spatial_similarity_search</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">ROI_column</span><span class="p">,</span> <span class="n">x_coordinate</span><span class="o">=</span><span class="s1">&#39;X_centroid&#39;</span><span class="p">,</span> <span class="n">y_coordinate</span><span class="o">=</span><span class="s1">&#39;Y_centroid&#39;</span><span class="p">,</span> <span class="n">similarity_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ROI_subset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">knn</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">imageid</span><span class="o">=</span><span class="s1">&#39;imageid&#39;</span><span class="p">,</span> <span class="n">use_raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;spatial_similarity_search&#39;</span><span class="p">,</span> <span class="n">reuse_similarity_matrix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">morphological_features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_only_morphological_features</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


  <div class="doc doc-contents ">
  

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>adata</code></td>
          <td>
          </td>
          <td><p>AnnData object loaded into memory or path to AnnData object.  </p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>ROI_column</code></td>
          <td>
          </td>
          <td><p>string, required<br />
Column name containing the ROI or region for which the similarity is sorted. This should be a small region in the
image that the user is interested in. The ROI can be added by using the <code>sm.pl.addROI_image</code> function.  </p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>ROI_subset</code></td>
          <td>
          </td>
          <td><p>list, optional<br />
A list of ROI's within the <code>ROI_column</code> for which similarity is sorted. By default similarity is calculated for 
every ROI within the <code>ROI_column</code>. The user can also restrict it to one or fewer ROI's by passing its name through 
this parameter. The default is None.  </p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>similarity_threshold</code></td>
          <td>
          </td>
          <td><p>float, optional<br />
This threshold can be changed to adjust for the strictness of similarity. Often the user would need to run this 
function with multiple <code>thresholds</code> to identify the best fit (based on visual interpretation of the results. 
To decrease compute time during this process the  similarity vectors are saved and hence this parameter can be 
coupled with <code>reuse_similarity_matrix</code> parameter for optimal run time efficiency. The default is 0.5.</p></td>
          <td>
                <code>0.5</code>
          </td>
        </tr>
        <tr>
          <td><code>x_coordinate</code></td>
          <td>
          </td>
          <td><p>float, required<br />
Column name containing the x-coordinates values.</p></td>
          <td>
                <code>&#39;X_centroid&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>y_coordinate</code></td>
          <td>
          </td>
          <td><p>float, required<br />
Column name containing the y-coordinates values.  </p></td>
          <td>
                <code>&#39;Y_centroid&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>method</code></td>
          <td>
          </td>
          <td><p>string, optional<br />
Two options are available: a) <code>radius</code>, b) <code>knn</code>.<br />
a) <code>radius</code> - Identifies the neighbours within a given radius for every cell.<br />
b) <code>knn</code> - Identifies the K nearest neigbours for every cell.  </p></td>
          <td>
                <code>&#39;radius&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>radius</code></td>
          <td>
          </td>
          <td><p>int, optional<br />
The radius used to define a local neighbhourhood.</p></td>
          <td>
                <code>30</code>
          </td>
        </tr>
        <tr>
          <td><code>knn</code></td>
          <td>
          </td>
          <td><p>int, optional<br />
Number of cells considered for defining the local neighbhourhood.</p></td>
          <td>
                <code>10</code>
          </td>
        </tr>
        <tr>
          <td><code>imageid</code></td>
          <td>
          </td>
          <td><p>string, optional<br />
Column name of the column containing the image id.</p></td>
          <td>
                <code>&#39;imageid&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>use_raw</code></td>
          <td>
          </td>
          <td><p>boolian, optional<br />
Argument to denote whether to use the raw data or scaled data after applying <code>sm.pp.rescale</code>.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>subset</code></td>
          <td>
          </td>
          <td><p>string, optional<br />
imageid of a single image to be subsetted for analyis. Note, if this is used, the similarity will 
not be computed for other images in the dataset. This is often used for quick look at a single image. </p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>label</code></td>
          <td>
          </td>
          <td><p>string, optional<br />
Key for the returned data, stored in <code>adata.obs</code>. The results will be stored as [label]_ROIname</p></td>
          <td>
                <code>&#39;spatial_similarity_search&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>reuse_similarity_matrix</code></td>
          <td>
          </td>
          <td><p>string, optional<br />
In order to save compute time for large datasets, this function can be run once and the <code>similarity_threshold</code> 
can be adjusted multiple times to identify the regions that best resemble the input ROI. In order to use this 
parameter, pass the <code>label</code> used when running this function for the first time. The defaul label is 
<code>spatial_similarity_search</code>. The default is None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>morphological_features</code></td>
          <td>
          </td>
          <td><p>list, optional<br />
For calculating the similarity between regions, in addition to the molecular/marker inforamtion, any additional 
information such as morphological features pertaining to individual cells can be passed into the algorithm. 
If the data was generated using the <code>mcmicro</code> pipeline these ['Area', 'MajorAxisLength','MinorAxisLength', 'Eccentricity', 'Solidity', 'Extent', 'Orientation'] 
are the usual morphological features that are captured. These can be passed into this parameter. Note one can use any additional 
feature that is stored in <code>adata.obs</code>. The default is None. </p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>use_only_morphological_features</code></td>
          <td>
          </td>
          <td><p>bool, optional<br />
If the user passes data through <code>morphological_features</code>, one also has an option to identify regions of similarity 
just using the morphological features. If <code>morphological_features</code> is included and <code>use_only_morphological_features</code> 
is set to <code>False</code>, both the morphological features and molecular features will be used. The default is False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>output_dir</code></td>
          <td>
          </td>
          <td><p>string, optional<br />
Path to output directory.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>adata</code></td>          <td>
          </td>
          <td><p>AnnData object<br />
Updated AnnData object with the results stored in <code>adata.obs [{label}_{ROIname}]</code>.</p></td>
        </tr>
    </tbody>
  </table>
      <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><div><pre><span></span><code>    <span class="c1"># Running the spatial_similarity_search with the radius method</span>
    <span class="n">adata</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">spatial_similarity_search</span> <span class="p">(</span><span class="n">adata</span><span class="p">,</span><span class="n">ROI_column</span> <span class="o">=</span> <span class="s1">&#39;Blood_Vessel_ROI&#39;</span><span class="p">,</span>
                                               <span class="n">similarity_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                               <span class="n">ROI_subset</span> <span class="o">=</span> <span class="s1">&#39;blood_vessel&#39;</span><span class="p">,</span>
                                               <span class="n">method</span><span class="o">=</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> 
                                               <span class="n">label</span><span class="o">=</span><span class="s1">&#39;spatial_similarity_search&#39;</span><span class="p">,</span>
                                               <span class="n">reuse_similarity_matrix</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Rerun to adjust the similarity_threshold while using the pre-computed similarity matrix</span>
    <span class="n">adata</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">spatial_similarity_search</span> <span class="p">(</span><span class="n">adata</span><span class="p">,</span><span class="n">ROI_column</span> <span class="o">=</span> <span class="s1">&#39;Blood_Vessel_ROI&#39;</span><span class="p">,</span>
                                               <span class="n">similarity_threshold</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                                               <span class="n">ROI_subset</span> <span class="o">=</span> <span class="s1">&#39;blood_vessel&#39;</span><span class="p">,</span>
                                               <span class="n">method</span><span class="o">=</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> 
                                               <span class="n">label</span><span class="o">=</span><span class="s1">&#39;spatial_similarity_search&#39;</span><span class="p">,</span>
                                               <span class="n">reuse_similarity_matrix</span><span class="o">=</span><span class="s1">&#39;spatial_similarity_search&#39;</span><span class="p">)</span>
    <span class="c1"># visulaize the results in napari</span>
    <span class="n">image_path</span> <span class="o">=</span> <span class="s2">&quot;/Users/aj/Documents/exemplar-001/registration/exemplar-001.ome.tif&quot;</span>
    <span class="n">sm</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">image_viewer</span> <span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">adata</span><span class="p">,</span> <span class="n">subset</span> <span class="o">=</span> <span class="s1">&#39;unmicst-exemplar-001_cell&#39;</span><span class="p">,</span> 
                        <span class="n">overlay</span><span class="o">=</span><span class="s1">&#39;spatial_similarity_search_blood_vessel&#39;</span><span class="p">,</span> <span class="n">point_color</span><span class="o">=</span><span class="s1">&#39;White&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

      <details class="quote">
        <summary>Source code in <code>scimap/tools/_spatial_similarity_search.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">spatial_similarity_search</span> <span class="p">(</span><span class="n">adata</span><span class="p">,</span><span class="n">ROI_column</span><span class="p">,</span>
                               <span class="n">x_coordinate</span><span class="o">=</span><span class="s1">&#39;X_centroid&#39;</span><span class="p">,</span>
                               <span class="n">y_coordinate</span><span class="o">=</span><span class="s1">&#39;Y_centroid&#39;</span><span class="p">,</span>
                               <span class="n">similarity_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                               <span class="n">ROI_subset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">method</span><span class="o">=</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> 
                               <span class="n">knn</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">imageid</span><span class="o">=</span><span class="s1">&#39;imageid&#39;</span><span class="p">,</span> 
                               <span class="n">use_raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">label</span><span class="o">=</span><span class="s1">&#39;spatial_similarity_search&#39;</span><span class="p">,</span>
                               <span class="n">reuse_similarity_matrix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">morphological_features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">use_only_morphological_features</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Parameters:</span>
<span class="sd">    adata : AnnData object loaded into memory or path to AnnData object.  </span>

<span class="sd">    ROI_column : string, required  </span>
<span class="sd">        Column name containing the ROI or region for which the similarity is sorted. This should be a small region in the</span>
<span class="sd">        image that the user is interested in. The ROI can be added by using the `sm.pl.addROI_image` function.  </span>

<span class="sd">    ROI_subset : list, optional  </span>
<span class="sd">        A list of ROI&#39;s within the `ROI_column` for which similarity is sorted. By default similarity is calculated for </span>
<span class="sd">        every ROI within the `ROI_column`. The user can also restrict it to one or fewer ROI&#39;s by passing its name through </span>
<span class="sd">        this parameter. The default is None.  </span>

<span class="sd">    similarity_threshold : float, optional  </span>
<span class="sd">        This threshold can be changed to adjust for the strictness of similarity. Often the user would need to run this </span>
<span class="sd">        function with multiple `thresholds` to identify the best fit (based on visual interpretation of the results. </span>
<span class="sd">        To decrease compute time during this process the  similarity vectors are saved and hence this parameter can be </span>
<span class="sd">        coupled with `reuse_similarity_matrix` parameter for optimal run time efficiency. The default is 0.5.</span>

<span class="sd">    x_coordinate : float, required  </span>
<span class="sd">        Column name containing the x-coordinates values.</span>

<span class="sd">    y_coordinate : float, required  </span>
<span class="sd">        Column name containing the y-coordinates values.  </span>

<span class="sd">    method : string, optional  </span>
<span class="sd">        Two options are available: a) `radius`, b) `knn`.  </span>
<span class="sd">        a) `radius` - Identifies the neighbours within a given radius for every cell.  </span>
<span class="sd">        b) `knn` - Identifies the K nearest neigbours for every cell.  </span>

<span class="sd">    radius : int, optional  </span>
<span class="sd">        The radius used to define a local neighbhourhood.</span>

<span class="sd">    knn : int, optional  </span>
<span class="sd">        Number of cells considered for defining the local neighbhourhood.</span>

<span class="sd">    imageid : string, optional  </span>
<span class="sd">        Column name of the column containing the image id.</span>

<span class="sd">    use_raw : boolian, optional  </span>
<span class="sd">        Argument to denote whether to use the raw data or scaled data after applying `sm.pp.rescale`.</span>

<span class="sd">    subset : string, optional  </span>
<span class="sd">        imageid of a single image to be subsetted for analyis. Note, if this is used, the similarity will </span>
<span class="sd">        not be computed for other images in the dataset. This is often used for quick look at a single image. </span>

<span class="sd">    label : string, optional  </span>
<span class="sd">        Key for the returned data, stored in `adata.obs`. The results will be stored as [label]_ROIname</span>

<span class="sd">    reuse_similarity_matrix : string, optional  </span>
<span class="sd">        In order to save compute time for large datasets, this function can be run once and the `similarity_threshold` </span>
<span class="sd">        can be adjusted multiple times to identify the regions that best resemble the input ROI. In order to use this </span>
<span class="sd">        parameter, pass the `label` used when running this function for the first time. The defaul label is </span>
<span class="sd">        `spatial_similarity_search`. The default is None.</span>

<span class="sd">    morphological_features : list, optional  </span>
<span class="sd">        For calculating the similarity between regions, in addition to the molecular/marker inforamtion, any additional </span>
<span class="sd">        information such as morphological features pertaining to individual cells can be passed into the algorithm. </span>
<span class="sd">        If the data was generated using the `mcmicro` pipeline these [&#39;Area&#39;, &#39;MajorAxisLength&#39;,&#39;MinorAxisLength&#39;, &#39;Eccentricity&#39;, &#39;Solidity&#39;, &#39;Extent&#39;, &#39;Orientation&#39;] </span>
<span class="sd">        are the usual morphological features that are captured. These can be passed into this parameter. Note one can use any additional </span>
<span class="sd">        feature that is stored in `adata.obs`. The default is None. </span>

<span class="sd">    use_only_morphological_features : bool, optional  </span>
<span class="sd">        If the user passes data through `morphological_features`, one also has an option to identify regions of similarity </span>
<span class="sd">        just using the morphological features. If `morphological_features` is included and `use_only_morphological_features` </span>
<span class="sd">        is set to `False`, both the morphological features and molecular features will be used. The default is False.</span>

<span class="sd">    output_dir : string, optional  </span>
<span class="sd">        Path to output directory.</span>

<span class="sd">Returns:</span>
<span class="sd">    adata : AnnData object  </span>
<span class="sd">        Updated AnnData object with the results stored in `adata.obs [{label}_{ROIname}]`.</span>

<span class="sd">Example:</span>
<span class="sd">```python</span>
<span class="sd">    # Running the spatial_similarity_search with the radius method</span>
<span class="sd">    adata = sm.tl.spatial_similarity_search (adata,ROI_column = &#39;Blood_Vessel_ROI&#39;,</span>
<span class="sd">                                               similarity_threshold=0.5,</span>
<span class="sd">                                               ROI_subset = &#39;blood_vessel&#39;,</span>
<span class="sd">                                               method=&#39;radius&#39;, radius=30, </span>
<span class="sd">                                               label=&#39;spatial_similarity_search&#39;,</span>
<span class="sd">                                               reuse_similarity_matrix=None)</span>

<span class="sd">    # Rerun to adjust the similarity_threshold while using the pre-computed similarity matrix</span>
<span class="sd">    adata = sm.tl.spatial_similarity_search (adata,ROI_column = &#39;Blood_Vessel_ROI&#39;,</span>
<span class="sd">                                               similarity_threshold=0.7,</span>
<span class="sd">                                               ROI_subset = &#39;blood_vessel&#39;,</span>
<span class="sd">                                               method=&#39;radius&#39;, radius=30, </span>
<span class="sd">                                               label=&#39;spatial_similarity_search&#39;,</span>
<span class="sd">                                               reuse_similarity_matrix=&#39;spatial_similarity_search&#39;)</span>
<span class="sd">    # visulaize the results in napari</span>
<span class="sd">    image_path = &quot;/Users/aj/Documents/exemplar-001/registration/exemplar-001.ome.tif&quot;</span>
<span class="sd">    sm.pl.image_viewer (image_path, adata, subset = &#39;unmicst-exemplar-001_cell&#39;, </span>
<span class="sd">                        overlay=&#39;spatial_similarity_search_blood_vessel&#39;, point_color=&#39;White&#39;)</span>

<span class="sd">```</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="c1">#x_coordinate=&#39;X_centroid&#39;; y_coordinate=&#39;Y_centroid&#39;; method=&#39;radius&#39;; radius=30; knn=10; imageid=&#39;imageid&#39;; </span>
    <span class="c1">#use_raw=True ; log=True; subset=None; label=&#39;spatial_similarity_search&#39;; output_dir=None; ROI_column=&#39;ASMA&#39;; ROI_subset = None; similarity_threshold=0.5</span>
    <span class="c1"># morphological_features = [&#39;Area&#39;, &#39;MajorAxisLength&#39;,&#39;MinorAxisLength&#39;, &#39;Eccentricity&#39;, &#39;Solidity&#39;, &#39;Extent&#39;, &#39;Orientation&#39;]</span>
    <span class="c1">#adata_subset = adata.copy()</span>

    <span class="c1"># Load the andata object    </span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">imid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">anndata</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">imid</span> <span class="o">=</span> <span class="s2">&quot;adata_spatial_similarity_search&quot;</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">adata</span>

    <span class="c1"># Error statements</span>
    <span class="k">if</span> <span class="n">use_raw</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Please run `sm.pp.rescale` first if you wish to use `use_raw = False`&#39;</span><span class="p">)</span>

    <span class="c1"># Function to calculate the distance between two vectors</span>
    <span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">euclidian_score</span><span class="p">(</span><span class="n">query_neighbourhood</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">spatial_lag_array</span> <span class="o">-</span> <span class="n">query_neighbourhood</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">spatial_expression_internal</span> <span class="p">(</span><span class="n">adata_subset</span><span class="p">,</span> <span class="n">x_coordinate</span><span class="p">,</span> <span class="n">y_coordinate</span><span class="p">,</span>
                                     <span class="n">method</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">knn</span><span class="p">,</span> <span class="n">imageid</span><span class="p">,</span> <span class="n">use_raw</span><span class="p">,</span>
                                     <span class="n">morphological_features</span><span class="p">,</span> <span class="n">use_only_morphological_features</span><span class="p">):</span>

        <span class="c1"># Create a DataFrame with the necessary inforamtion</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">adata_subset</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">x_coordinate</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">adata_subset</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">y_coordinate</span><span class="p">]})</span>

        <span class="c1"># Identify neighbourhoods based on the method used</span>
        <span class="c1"># a) KNN method</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;knn&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Identifying the &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">knn</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; nearest neighbours for every cell&quot;</span><span class="p">)</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">BallTree</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">leaf_size</span><span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">dist</span><span class="p">,</span> <span class="n">ind</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">knn</span><span class="p">,</span> <span class="n">return_distance</span><span class="o">=</span> <span class="kc">True</span><span class="p">)</span>


        <span class="c1"># b) Local radius method</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;radius&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Identifying neighbours within &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; pixels of every cell&quot;</span><span class="p">)</span>
            <span class="n">kdt</span> <span class="o">=</span> <span class="n">BallTree</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span>
            <span class="n">ind</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">kdt</span><span class="o">.</span><span class="n">query_radius</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">return_distance</span><span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Normalize range (0-1) and account for total number of cells </span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">lil_matrix</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">dist</span><span class="p">)):</span>
            <span class="c1"># Drop self-distance element.</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">columns</span> <span class="o">!=</span> <span class="n">row</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Normalize distances.</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">values</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                <span class="n">values</span> <span class="o">/=</span> <span class="n">values</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="c1"># Assign row to matrix.</span>
            <span class="n">d</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>

        <span class="c1"># convert to csr sparse matrix</span>
        <span class="n">wn_matrix_sparse</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>

        <span class="c1"># to dense matrix</span>
        <span class="c1">#dense = pd.DataFrame(wn_matrix_sparse.todense())</span>


        <span class="c1"># normalize data</span>
        <span class="n">molecular_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">adata_subset</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">adata_subset</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">adata_subset</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="c1"># clip outliers</span>
        <span class="k">def</span> <span class="nf">clipping</span> <span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="n">clip</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mf">0.01</span><span class="p">),</span> <span class="n">upper</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mf">99.99</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">clip</span>
        <span class="n">gmm_data</span> <span class="o">=</span> <span class="n">molecular_matrix</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">clipping</span><span class="p">)</span>
        <span class="c1"># log trasform</span>
        <span class="n">normalised_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">gmm_data</span><span class="p">)</span>
        <span class="c1"># scale data</span>
        <span class="c1">#transformer = RobustScaler().fit(n_log)</span>
        <span class="c1">#normalised_data = pd.DataFrame(transformer.transform(n_log), columns = adata_subset.var.index, index=adata_subset.obs.index)</span>
        <span class="c1">#normalised_data = n_log</span>

        <span class="c1">#### Calculation of spatial lag</span>

        <span class="c1"># a) use only morphological features?</span>
        <span class="k">if</span> <span class="n">morphological_features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">morphological_features</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">morphological_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">morphological_features</span><span class="p">]</span>
            <span class="n">morph_f</span> <span class="o">=</span> <span class="n">adata_subset</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">morphological_features</span><span class="p">]</span>

            <span class="n">transformer</span> <span class="o">=</span> <span class="n">RobustScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">morph_f</span><span class="p">)</span>
            <span class="n">morph_f</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">morph_f</span><span class="p">),</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">morph_f</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">morph_f</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">use_only_morphological_features</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">spatial_lag</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">wn_matrix_sparse</span> <span class="o">*</span> <span class="n">morph_f</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">morph_f</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">morph_f</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>


        <span class="c1"># b) use morphological features and molecular features?</span>
        <span class="k">if</span> <span class="n">morphological_features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">use_only_morphological_features</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_raw</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                <span class="n">combined_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">normalised_data</span><span class="p">,</span> <span class="n">morph_f</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">spatial_lag</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">wn_matrix_sparse</span> <span class="o">*</span> <span class="n">combined_matrix</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">combined_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">combined_matrix</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>     
            <span class="k">else</span><span class="p">:</span>
                <span class="n">molecular_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">adata_subset</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">adata_subset</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">adata_subset</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="n">combined_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">molecular_matrix</span><span class="p">,</span> <span class="n">morph_f</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">spatial_lag</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">wn_matrix_sparse</span> <span class="o">*</span> <span class="n">combined_matrix</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">combined_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">combined_matrix</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> 

        <span class="c1"># c) use only molecular features</span>
        <span class="k">if</span> <span class="n">morphological_features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_raw</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                <span class="n">spatial_lag</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">wn_matrix_sparse</span> <span class="o">*</span> <span class="n">normalised_data</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">adata_subset</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">adata_subset</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">spatial_lag</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">wn_matrix_sparse</span> <span class="o">*</span> <span class="n">adata_subset</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">adata_subset</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">adata_subset</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># return value</span>
        <span class="k">return</span> <span class="n">spatial_lag</span>


    <span class="c1"># check if the user wants to reuse the spatial lag vector that was previously calculated</span>
    <span class="k">if</span> <span class="n">reuse_similarity_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Subset a particular image if needed</span>
        <span class="k">if</span> <span class="n">subset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subset</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">subset</span> <span class="o">=</span> <span class="p">[</span><span class="n">subset</span><span class="p">]</span>
            <span class="n">adata_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">imageid</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">subset</span><span class="p">)]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">adata_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">imageid</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">imageid</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()]</span>


        <span class="c1"># Apply function to all images and create a master dataframe</span>
        <span class="c1"># Create lamda function </span>
        <span class="n">r_spatial_expression_internal</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">spatial_expression_internal</span><span class="p">(</span><span class="n">adata_subset</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> 
                                                                    <span class="n">x_coordinate</span><span class="o">=</span><span class="n">x_coordinate</span><span class="p">,</span> 
                                                                    <span class="n">y_coordinate</span><span class="o">=</span><span class="n">y_coordinate</span><span class="p">,</span> 
                                                                    <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> 
                                                                    <span class="n">knn</span><span class="o">=</span><span class="n">knn</span><span class="p">,</span> <span class="n">imageid</span><span class="o">=</span><span class="n">imageid</span><span class="p">,</span> 
                                                                    <span class="n">use_raw</span><span class="o">=</span><span class="n">use_raw</span><span class="p">,</span>
                                                                    <span class="n">morphological_features</span><span class="o">=</span><span class="n">morphological_features</span><span class="p">,</span> 
                                                                    <span class="n">use_only_morphological_features</span><span class="o">=</span><span class="n">use_only_morphological_features</span><span class="p">)</span> 

        <span class="n">all_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">r_spatial_expression_internal</span><span class="p">,</span> <span class="n">adata_list</span><span class="p">))</span> <span class="c1"># Apply function </span>

        <span class="c1"># Merge all the results into a single dataframe    </span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_data</span><span class="p">)):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>  

        <span class="c1"># save the results in adata object</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">reuse_similarity_matrix</span><span class="p">]</span>


    <span class="c1">### Identify the ROI&#39;s of interest and then correlate it with all spatial lag</span>

    <span class="c1"># calculate the distance between queri ROI and all neighbourhoods</span>
    <span class="c1"># figure out the roi&#39;s that need to be processed</span>
    <span class="k">if</span> <span class="n">ROI_subset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ROI_subset</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">ROI_column</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">ROI_subset</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ROI_subset</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;Other&#39;</span> <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ROI_subset</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">ROI_subset</span> <span class="o">=</span> <span class="p">[</span><span class="n">ROI_subset</span><span class="p">]</span>


    <span class="c1"># Figure out all the cells that fall within the user defined ROI&#39;s</span>
    <span class="n">query_neigh</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">ROI_column</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">ROI_subset</span><span class="p">)]</span><span class="o">.</span><span class="n">obs</span><span class="p">[[</span><span class="n">ROI_column</span><span class="p">]]</span>

    <span class="c1">#result = spatial_lag</span>
    <span class="c1">#np.max(all_roi_scores)</span>
    <span class="c1">#np.min(all_roi_scores)</span>

    <span class="c1"># for each ROI calculate the median spatial lag</span>
    <span class="n">median_spatial_lag</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">query_neigh</span><span class="o">.</span><span class="n">index</span><span class="p">],</span> <span class="n">query_neigh</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
    <span class="n">median_spatial_lag</span> <span class="o">=</span> <span class="n">median_spatial_lag</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ROI_column</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>

    <span class="c1"># apply the distance function to each defined ROI&#39;s</span>
    <span class="n">spatial_lag_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">median_spatial_lag_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">median_spatial_lag</span><span class="p">)</span>

    <span class="c1"># func</span>
    <span class="c1">#all_roi_scores = np.array([distance.euclidean(median_spatial_lag_array[0],x) for x in spatial_lag_array])</span>
    <span class="c1">#all_roi_scores = pd.DataFrame(all_roi_scores, columns=median_spatial_lag.index, index = result.index)</span>
    <span class="n">all_roi_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">euclidian_score</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">median_spatial_lag_array</span><span class="p">])</span>
    <span class="c1">#all_roi_scores = median_spatial_lag.apply(euclidian_score, axis = 1) when spatial lag is a df</span>
    <span class="c1"># convert that to a df for returning</span>
    <span class="n">all_roi_scores</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_roi_scores</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">median_spatial_lag</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># rescale the scores</span>
    <span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">all_roi_scores</span><span class="p">)</span>
    <span class="n">all_roi_scores</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">all_roi_scores</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span> <span class="n">all_roi_scores</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="c1">### Threshold the results to identify neighbourhoods that are similar to the </span>
    <span class="n">all_roi_scores_threshold</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">all_roi_scores</span> <span class="o">&gt;=</span> <span class="n">similarity_threshold</span><span class="p">,</span> <span class="s1">&#39;similar_to_ROI&#39;</span><span class="p">,</span> <span class="s1">&#39;other&#39;</span><span class="p">),</span> <span class="n">index</span> <span class="o">=</span> <span class="n">all_roi_scores</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">all_roi_scores</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="c1"># rename columns of the </span>
    <span class="n">A</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_roi_scores</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">A</span><span class="p">]</span>
    <span class="n">all_roi_scores_threshold</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">column_names</span>

    <span class="c1"># delete the result columns from adata if they already exist</span>
    <span class="n">adata_obs</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">adata_obs</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">):</span>
        <span class="n">adata_obs</span> <span class="o">=</span> <span class="n">adata_obs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">column_names</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Merge the results with adata.obs</span>
    <span class="n">final_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">adata_obs</span><span class="p">,</span> <span class="n">all_roi_scores_threshold</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>

    <span class="c1"># Reindex the cells</span>
    <span class="n">final_results</span> <span class="o">=</span> <span class="n">final_results</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;not_computed&#39;</span><span class="p">)</span>
    <span class="n">final_results</span> <span class="o">=</span> <span class="n">final_results</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="c1"># return the data</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">final_results</span>

    <span class="c1"># Save data if requested</span>
    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="n">imid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>    
        <span class="c1"># Return data</span>
        <span class="k">return</span> <span class="n">adata</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>


  


  



                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://twitter.com/ajitjohnson_n" target="_blank" rel="noopener" title="Twitter" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.top", "search.highlight"], "search": "../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.b4d07000.min.js"></script>
      
    
  </body>
</html>