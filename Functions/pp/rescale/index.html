
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Single-Cell Image Analysis Package">
      
      
        <meta name="author" content="Ajit Johnson Nirmal">
      
      
      
        <link rel="prev" href="../mcmicro_to_scimap/">
      
      
        <link rel="next" href="../combat/">
      
      <link rel="icon" href="../../../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.15">
    
    
      
        <title>rescale - scimap</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-22X9HCL4YP"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-22X9HCL4YP",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-22X9HCL4YP",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#scimap.preprocessing._rescale" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="scimap" class="md-header__button md-logo" aria-label="scimap" data-md-component="logo">
      
  <img src="../../../assets/favicon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            scimap
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              rescale
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/ajitjohnson/scimap" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../../Getting%20Started/" class="md-tabs__link">
      Getting Started
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../../Tools%20Shortcut/" class="md-tabs__link">
      Tools Shortcut
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../mcmicro_to_scimap/" class="md-tabs__link md-tabs__link--active">
        SCIMAP Functions
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../tutorials/1-scimap-tutorial-getting-started/" class="md-tabs__link">
        Tutorials
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="scimap" class="md-nav__button md-logo" aria-label="scimap" data-md-component="logo">
      
  <img src="../../../assets/favicon.png" alt="logo">

    </a>
    scimap
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ajitjohnson/scimap" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../Getting%20Started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../Tools%20Shortcut/" class="md-nav__link">
        Tools Shortcut
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          SCIMAP Functions
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          SCIMAP Functions
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
          Pre Processing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Pre Processing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../mcmicro_to_scimap/" class="md-nav__link">
        mcmicro_to_scimap
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          rescale
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        rescale
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#scimap.preprocessing._rescale" class="md-nav__link">
    scimap.preprocessing._rescale
  </a>
  
    <nav class="md-nav" aria-label="scimap.preprocessing._rescale">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scimap.preprocessing._rescale--function" class="md-nav__link">
    Function
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scimap.preprocessing._rescale.rescale" class="md-nav__link">
    rescale()
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../combat/" class="md-nav__link">
        combat
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
      
      
      
        <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
          Tools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Tools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tl/phenotype_cells/" class="md-nav__link">
        phenotype_cells
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tl/cluster/" class="md-nav__link">
        cluster
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tl/umap/" class="md-nav__link">
        umap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tl/foldchange/" class="md-nav__link">
        foldchange
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tl/spatial_distance/" class="md-nav__link">
        spatial_distance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tl/spatial_interaction/" class="md-nav__link">
        spatial_interaction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tl/spatial_count/" class="md-nav__link">
        spatial_count
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tl/spatial_lda/" class="md-nav__link">
        spatial_lda
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tl/spatial_expression/" class="md-nav__link">
        spatial_expression
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tl/spatial_cluster/" class="md-nav__link">
        spatial_cluster
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tl/spatial_pscore/" class="md-nav__link">
        spatial_pscore
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tl/spatial_aggregate/" class="md-nav__link">
        spatial_aggregate
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tl/spatial_similarity_search/" class="md-nav__link">
        spatial_similarity_search
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
      
      
      
        <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
          Plotting Functions
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Plotting Functions
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/image_viewer/" class="md-nav__link">
        image_viewer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/addROI_image/" class="md-nav__link">
        addROI_image
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/gate_finder/" class="md-nav__link">
        gate_finder
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/distPlot/" class="md-nav__link">
        distPlot
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/densityPlot2D/" class="md-nav__link">
        densityPlot2D
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/cluster_plots/" class="md-nav__link">
        cluster_plots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/umap/" class="md-nav__link">
        umap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/foldchange/" class="md-nav__link">
        foldchange
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/spatial_scatterPlot/" class="md-nav__link">
        spatial_scatterPlot
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/spatial_distance/" class="md-nav__link">
        spatial_distance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/spatial_interaction/" class="md-nav__link">
        spatial_interaction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/spatial_pscore/" class="md-nav__link">
        spatial_pscore
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/stacked_barplot/" class="md-nav__link">
        stacked_barplot
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/pie/" class="md-nav__link">
        pie
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pl/voronoi/" class="md-nav__link">
        voronoi
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
          Helper Functions
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_4">
          <span class="md-nav__icon md-icon"></span>
          Helper Functions
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hl/classify/" class="md-nav__link">
        classify
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hl/rename/" class="md-nav__link">
        rename
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hl/addROI_omero/" class="md-nav__link">
        addROI_omero
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hl/dropFeatures/" class="md-nav__link">
        dropFeatures
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hl/animate/" class="md-nav__link">
        animate
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hl/scimap_to_csv/" class="md-nav__link">
        scimap_to_csv
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Tutorials
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/1-scimap-tutorial-getting-started/" class="md-nav__link">
        Getting Started with Scimap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/2-scimap-tutorial-cell-phenotyping/" class="md-nav__link">
        Cell-Phenotyping using Scimap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/3-Cell_Type_calling_and_adding_ROIs/" class="md-nav__link">
        Cell-Phenotyping and adding ROIs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/4-CellType_Proportion_Exploration/" class="md-nav__link">
        CellType Proportion Exploration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/5-Simple_Spatial_Analysis/" class="md-nav__link">
        Simple Spatial Analysis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/6_animate_with_scimap/" class="md-nav__link">
        Animate with scimap
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#scimap.preprocessing._rescale" class="md-nav__link">
    scimap.preprocessing._rescale
  </a>
  
    <nav class="md-nav" aria-label="scimap.preprocessing._rescale">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scimap.preprocessing._rescale--function" class="md-nav__link">
    Function
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scimap.preprocessing._rescale.rescale" class="md-nav__link">
    rescale()
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>rescale</h1>

<div class="doc doc-object doc-module">


<a id="scimap.preprocessing._rescale"></a>
  <div class="doc doc-contents first">
  
      <div class="admonition abstract">
<p class="admonition-title">Short Description</p>
<p><code>sm.pp.rescale</code>: The function allows users to rescale the data. This step is often performed to standardize the 
the expression of all markers to a common scale. The rescaling can be either performed automatically or manually. 
User defined gates can be passed to rescale the data manually, else the algorithm fits a GMM (gaussian mixed model) to 
identify the cutoff point. The resultant data is between 0-1 where values below 0.5 are considered non-expressing while 
above 0.5 is considered positive. </p>
</div>
<h5 id="scimap.preprocessing._rescale--function">Function</h5>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h4 id="scimap.preprocessing._rescale.rescale" class="doc doc-heading">
<code class="highlight language-python"><span class="n">rescale</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">gate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">imageid</span><span class="o">=</span><span class="s1">&#39;imageid&#39;</span><span class="p">,</span> <span class="n">failed_markers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

</h4>


  <div class="doc doc-contents ">
  

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>adata</code></td>
          <td>
          </td>
          <td><p>AnnData Object  </p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>gate</code></td>
          <td>
          </td>
          <td><p>dataframe, optional<br />
DataFrame with first column as markers and subsequent column with gate values for each image in the dataset.
The column names should correspond to the unique <code>imageid</code>. If only one column of gate is provied 
to a dataset with multiple images, the same gate will be applied to all images.
Note: If gates are not provided or left out for a particular marker, the function will try to 
automatically identify a gate based on applying gaussian mixture modeling algorithm (GMM). The default is None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>log</code></td>
          <td>
          </td>
          <td><p>bool, optional<br />
By default the data stored in <code>adata.raw.X</code> is extracted for scaling. If the user wishes to log transform (log1p)
it before applying the gates, this parameter can be set to True. Please note if the function is used to 
identify gates based on GMM, it is recommended for the data to be log transformed. The default is True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>imageid</code></td>
          <td>
          </td>
          <td><p>string, optional<br />
The column containing the Image IDs. When passing manual gates the columns of the dataframe need to match 
to the elements within the passed <code>imageid</code> column. The default is 'imageid'.</p></td>
          <td>
                <code>&#39;imageid&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>failed_markers</code></td>
          <td>
          </td>
          <td><p>dict, optional<br />
Markers that were deemed to have failed based on prior visual inspection. This parameter accepts a python 
dictionary with <code>key</code> as <code>imageid</code> and <code>value</code> as markers that failed in that particular <code>imageid</code>. 
Example: <code>failed_markers = {'image_1': ['failed_marker_1'], 'image_2' : ['failed_marker_1', 'failed_marker_2']}</code>. 
To make it easier to allow specifying markers that failed in <code>all</code> images within the dataset, the parameter also 
recognizes the special keyword <code>all</code>. For example, <code>failed_markers = {'all': ['failed_marker_X'], 'image_2' : ['failed_marker_1', 'failed_marker_2']}</code>. 
The default is None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>method</code></td>
          <td>
          </td>
          <td><p>string, optional<br />
Two avialble option are- 'all' or 'by_image'. In the event that multiple images were loaded in with distinct 'imageid',
users have the option to apply GMM by pooling all data togeather or to apply it to each image independently. 
Please be aware of batch effects when passing 'all' to multiple images. In contrast, if there are not enough variation 
within individual images, the GMM cannot reliably distinguish between the negative and positive populations as well.  </p></td>
          <td>
                <code>&#39;all&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>random_state</code></td>
          <td>
          </td>
          <td><p>int, optional<br />
Seed for GMM. The default is 0.</p></td>
          <td>
                <code>0</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td><p>Modified AnnData Object
The values in <code>adata.X</code> are replaced with the scaled data.
The final gates used for saving the data is also stored in <code>adata.uns['gates']</code></p></td>
        </tr>
    </tbody>
  </table>
      <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1"># create a df with manual gates</span>
<span class="n">manual_gate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;marker&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;CD3D&#39;</span><span class="p">,</span> <span class="s1">&#39;KI67&#39;</span><span class="p">],</span> <span class="s1">&#39;gate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]})</span> 
<span class="n">adata</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">rescale</span> <span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">gate</span><span class="o">=</span><span class="n">manual_gate</span><span class="p">,</span> <span class="n">failed_markers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;all&#39;</span><span class="p">:[</span><span class="s1">&#39;CD20&#39;</span><span class="p">,</span> <span class="s1">&#39;CD21&#39;</span><span class="p">]})</span>

<span class="c1"># you could also import the gates as a pandas dataframe without index</span>
<span class="n">manual_gate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;manual_gates.csv&#39;</span><span class="p">)</span>
<span class="n">adata</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">rescale</span> <span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">gate</span><span class="o">=</span><span class="n">manual_gate</span><span class="p">,</span> <span class="n">failed_markers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;all&#39;</span><span class="p">:[</span><span class="s1">&#39;CD20&#39;</span><span class="p">,</span> <span class="s1">&#39;CD21&#39;</span><span class="p">]})</span>

<span class="c1"># The function can also be run without providing manual gates. This will trigger the GMM mode</span>
<span class="n">adata</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">rescale</span> <span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">gate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">failed_markers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;all&#39;</span><span class="p">:[</span><span class="s1">&#39;CD20&#39;</span><span class="p">,</span> <span class="s1">&#39;CD21&#39;</span><span class="p">]})</span>
</code></pre></div></td></tr></table></div>

      <details class="quote">
        <summary>Source code in <code>scimap/preprocessing/_rescale.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">rescale</span> <span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">gate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">imageid</span><span class="o">=</span><span class="s1">&#39;imageid&#39;</span><span class="p">,</span> <span class="n">failed_markers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">method</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Parameters:</span>

<span class="sd">    adata : AnnData Object  </span>

<span class="sd">    gate : dataframe, optional  </span>
<span class="sd">        DataFrame with first column as markers and subsequent column with gate values for each image in the dataset.</span>
<span class="sd">        The column names should correspond to the unique `imageid`. If only one column of gate is provied </span>
<span class="sd">        to a dataset with multiple images, the same gate will be applied to all images.</span>
<span class="sd">        Note: If gates are not provided or left out for a particular marker, the function will try to </span>
<span class="sd">        automatically identify a gate based on applying gaussian mixture modeling algorithm (GMM). The default is None.</span>

<span class="sd">    log : bool, optional  </span>
<span class="sd">        By default the data stored in `adata.raw.X` is extracted for scaling. If the user wishes to log transform (log1p)</span>
<span class="sd">        it before applying the gates, this parameter can be set to True. Please note if the function is used to </span>
<span class="sd">        identify gates based on GMM, it is recommended for the data to be log transformed. The default is True.</span>

<span class="sd">    imageid : string, optional  </span>
<span class="sd">        The column containing the Image IDs. When passing manual gates the columns of the dataframe need to match </span>
<span class="sd">        to the elements within the passed `imageid` column. The default is &#39;imageid&#39;.</span>

<span class="sd">    failed_markers : dict, optional  </span>
<span class="sd">        Markers that were deemed to have failed based on prior visual inspection. This parameter accepts a python </span>
<span class="sd">        dictionary with `key` as `imageid` and `value` as markers that failed in that particular `imageid`. </span>
<span class="sd">        Example: `failed_markers = {&#39;image_1&#39;: [&#39;failed_marker_1&#39;], &#39;image_2&#39; : [&#39;failed_marker_1&#39;, &#39;failed_marker_2&#39;]}`. </span>
<span class="sd">        To make it easier to allow specifying markers that failed in `all` images within the dataset, the parameter also </span>
<span class="sd">        recognizes the special keyword `all`. For example, `failed_markers = {&#39;all&#39;: [&#39;failed_marker_X&#39;], &#39;image_2&#39; : [&#39;failed_marker_1&#39;, &#39;failed_marker_2&#39;]}`. </span>
<span class="sd">        The default is None.</span>

<span class="sd">    method : string, optional  </span>
<span class="sd">        Two avialble option are- &#39;all&#39; or &#39;by_image&#39;. In the event that multiple images were loaded in with distinct &#39;imageid&#39;,</span>
<span class="sd">        users have the option to apply GMM by pooling all data togeather or to apply it to each image independently. </span>
<span class="sd">        Please be aware of batch effects when passing &#39;all&#39; to multiple images. In contrast, if there are not enough variation </span>
<span class="sd">        within individual images, the GMM cannot reliably distinguish between the negative and positive populations as well.  </span>

<span class="sd">    random_state : int, optional  </span>
<span class="sd">        Seed for GMM. The default is 0.</span>

<span class="sd">Returns:</span>

<span class="sd">    Modified AnnData Object</span>
<span class="sd">        The values in `adata.X` are replaced with the scaled data.</span>
<span class="sd">        The final gates used for saving the data is also stored in `adata.uns[&#39;gates&#39;]`</span>

<span class="sd">Example:</span>
<span class="sd">```python</span>
<span class="sd"># create a df with manual gates</span>
<span class="sd">manual_gate = pd.DataFrame({&#39;marker&#39;: [&#39;CD3D&#39;, &#39;KI67&#39;], &#39;gate&#39;: [7, 8]}) </span>
<span class="sd">adata = sm.pp.rescale (adata, gate=manual_gate, failed_markers={&#39;all&#39;:[&#39;CD20&#39;, &#39;CD21&#39;]})</span>

<span class="sd"># you could also import the gates as a pandas dataframe without index</span>
<span class="sd">manual_gate = pd.read_csv(&#39;manual_gates.csv&#39;)</span>
<span class="sd">adata = sm.pp.rescale (adata, gate=manual_gate, failed_markers={&#39;all&#39;:[&#39;CD20&#39;, &#39;CD21&#39;]})</span>

<span class="sd"># The function can also be run without providing manual gates. This will trigger the GMM mode</span>
<span class="sd">adata = sm.pp.rescale (adata, gate=None, failed_markers={&#39;all&#39;:[&#39;CD20&#39;, &#39;CD21&#39;]})</span>

<span class="sd">```</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#log=True; imageid=&#39;imageid&#39;; failed_markers=None; method=&#39;all&#39;; random_state=0</span>

    <span class="c1"># make a copy to raw data if raw is none</span>
    <span class="k">if</span> <span class="n">adata</span><span class="o">.</span><span class="n">raw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">adata</span>

    <span class="c1"># Mapping between markers and gates in the given dataset</span>
    <span class="n">dataset_markers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">dataset_images</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">imageid</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="n">m</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">dataset_markers</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">dataset_images</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">m</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">m</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span> <span class="s1">&#39;imageid&#39;</span><span class="p">,</span> <span class="s1">&#39;gate&#39;</span><span class="p">]</span>
    <span class="c1"># Manipulate m with and without provided manual fates</span>
    <span class="k">if</span> <span class="n">gate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gate_mapping</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">gate</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">dataset_images</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">global_manual_m</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">gate</span><span class="p">,</span> <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="n">gate</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">global_manual_m</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span> <span class="s1">&#39;imageid&#39;</span><span class="p">,</span> <span class="s1">&#39;m_gate&#39;</span><span class="p">]</span>
        <span class="n">gate_mapping</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">gate_mapping</span><span class="o">.</span><span class="n">gate</span> <span class="o">=</span> <span class="n">gate_mapping</span><span class="o">.</span><span class="n">gate</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">gate_mapping</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">global_manual_m</span><span class="o">.</span><span class="n">markers</span><span class="p">,</span> <span class="n">global_manual_m</span><span class="o">.</span><span class="n">m_gate</span><span class="p">))))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">manual_m</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">gate</span><span class="p">,</span> <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="n">gate</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">manual_m</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span> <span class="s1">&#39;imageid&#39;</span><span class="p">,</span> <span class="s1">&#39;m_gate&#39;</span><span class="p">]</span>
        <span class="n">gate_mapping</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">manual_m</span><span class="p">,</span>  <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span><span class="s1">&#39;imageid&#39;</span><span class="p">],</span> <span class="n">right_on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span><span class="s1">&#39;imageid&#39;</span><span class="p">])</span>
        <span class="n">gate_mapping</span><span class="p">[</span><span class="s1">&#39;gate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gate_mapping</span><span class="p">[</span><span class="s1">&#39;gate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">gate_mapping</span><span class="p">[</span><span class="s1">&#39;m_gate&#39;</span><span class="p">])</span>
        <span class="n">gate_mapping</span> <span class="o">=</span> <span class="n">gate_mapping</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;m_gate&#39;</span><span class="p">)</span>

    <span class="c1"># Addressing failed markers</span>
    <span class="k">def</span> <span class="nf">process_failed</span> <span class="p">(</span><span class="n">adata_subset</span><span class="p">,</span> <span class="n">foramted_failed_markers</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing Failed Marker in &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">adata_subset</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">imageid</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="c1"># prepare data</span>
        <span class="n">data_subset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">adata_subset</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">adata_subset</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">adata_subset</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">data_subset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">data_subset</span><span class="p">)</span>

        <span class="c1"># subset markers in the subset</span>
        <span class="n">fm_sub</span> <span class="o">=</span> <span class="n">foramted_failed_markers</span><span class="p">[</span><span class="n">adata_subset</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">imageid</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>


        <span class="k">def</span> <span class="nf">process_failed_internal</span> <span class="p">(</span><span class="n">fail_mark</span><span class="p">,</span> <span class="n">data_subset</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">data_subset</span><span class="p">[</span><span class="n">fail_mark</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">r_process_failed_internal</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">process_failed_internal</span> <span class="p">(</span><span class="n">fail_mark</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">data_subset</span><span class="o">=</span><span class="n">data_subset</span><span class="p">)</span>
        <span class="n">f_g</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">r_process_failed_internal</span><span class="p">,</span> <span class="p">[</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fm_sub</span><span class="o">.</span><span class="n">values</span><span class="p">]))</span>
        <span class="n">subset_gate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="p">{</span><span class="s1">&#39;markers&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fm_sub</span><span class="o">.</span><span class="n">values</span><span class="p">],</span>  
                       <span class="s1">&#39;imageid&#39;</span><span class="p">:</span> <span class="n">adata_subset</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">imageid</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                       <span class="s1">&#39;gate&#39;</span><span class="p">:</span> <span class="n">f_g</span><span class="p">,})</span>     
        <span class="c1"># return</span>
        <span class="k">return</span> <span class="n">subset_gate</span>

    <span class="c1"># Identify the failed markers</span>
    <span class="k">if</span> <span class="n">failed_markers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># check if failed marker is a dict</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">failed_markers</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="s1">&#39;`failed_markers` should be a python dictionary, please refer documentation&#39;</span><span class="p">)</span>
        <span class="c1"># create a copy </span>
        <span class="n">fm</span> <span class="o">=</span> <span class="n">failed_markers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># seperate all from the rest</span>
        <span class="k">if</span> <span class="s1">&#39;all&#39;</span> <span class="ow">in</span> <span class="n">failed_markers</span><span class="p">:</span>
            <span class="n">all_failed</span> <span class="o">=</span> <span class="n">failed_markers</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">all_failed</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">all_failed</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_failed</span><span class="p">]</span>
            <span class="n">failed_markers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">imageid</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_failed</span><span class="p">)):</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">all_failed</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
            <span class="c1">#for i in  range(len(df.columns)):</span>
            <span class="c1">#    df.loc[i] = all_failed[i]</span>
        <span class="c1"># rest of the failed markers</span>
        <span class="c1">#fail = pd.DataFrame.from_dict(failed_markers)        </span>
        <span class="n">fail</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">([</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">failed_markers</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">]))</span>
        <span class="c1"># merge</span>
        <span class="k">if</span> <span class="s1">&#39;all&#39;</span> <span class="ow">in</span> <span class="n">fm</span><span class="p">:</span>
            <span class="n">foramted_failed_markers</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">fail</span><span class="p">,</span> <span class="n">df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">foramted_failed_markers</span> <span class="o">=</span> <span class="n">fail</span>

        <span class="c1"># send the adata objects that need to be processed</span>
        <span class="c1"># Check if any image needs to pass through the GMM protocol</span>
        <span class="n">adata_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">imageid</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">foramted_failed_markers</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="c1"># apply the process_failed function</span>
        <span class="n">r_process_failed</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">process_failed</span> <span class="p">(</span><span class="n">adata_subset</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">foramted_failed_markers</span><span class="o">=</span><span class="n">foramted_failed_markers</span><span class="p">)</span>
        <span class="n">failed_gates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">r_process_failed</span><span class="p">,</span> <span class="n">adata_list</span><span class="p">))</span>    
        <span class="c1"># combine the results and merge with gate_mapping</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">failed_gates</span><span class="p">)):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">failed_gates</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
        <span class="c1"># use this to merge with gate_mapping</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">gate_mapping</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span> <span class="s1">&#39;imageid&#39;</span><span class="p">])[</span><span class="s1">&#39;gate&#39;</span><span class="p">]</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span> <span class="s1">&#39;imageid&#39;</span><span class="p">])[</span><span class="s1">&#39;gate&#39;</span><span class="p">]</span>
        <span class="n">x1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
        <span class="n">gate_mapping</span> <span class="o">=</span> <span class="n">x1</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="c1"># trim the data before applying GMM</span>
    <span class="k">def</span> <span class="nf">clipping</span> <span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">clip</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mf">0.01</span><span class="p">),</span> <span class="n">upper</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mf">99.99</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">clip</span>

    <span class="c1"># Find GMM based gates</span>
    <span class="k">def</span> <span class="nf">gmm_gating</span> <span class="p">(</span><span class="n">marker</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finding the optimal gate by GMM for &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">marker</span><span class="p">))</span>
        <span class="n">data_gm</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">marker</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">gmm</span> <span class="o">=</span> <span class="n">GaussianMixture</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_gm</span><span class="p">)</span>
        <span class="n">gate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">gmm</span><span class="o">.</span><span class="n">means_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gate</span>

    <span class="c1"># Running gmm_gating on the dataset</span>
    <span class="k">def</span> <span class="nf">gmm_gating_internal</span> <span class="p">(</span><span class="n">adata_subset</span><span class="p">,</span> <span class="n">gate_mapping</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GMM for &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">adata_subset</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">imageid</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
        <span class="n">data_subset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">adata_subset</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">adata_subset</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">adata_subset</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>      
        <span class="c1"># find markers</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">image_specific</span> <span class="o">=</span> <span class="n">gate_mapping</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">marker_to_gate</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gate_mapping</span><span class="p">[</span><span class="n">gate_mapping</span><span class="o">.</span><span class="n">gate</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>        
            <span class="n">image_specific</span> <span class="o">=</span> <span class="n">gate_mapping</span><span class="p">[</span><span class="n">gate_mapping</span><span class="p">[</span><span class="s1">&#39;imageid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">adata_subset</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">imageid</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())]</span>
            <span class="n">marker_to_gate</span> <span class="o">=</span> <span class="n">image_specific</span><span class="p">[</span><span class="n">image_specific</span><span class="o">.</span><span class="n">gate</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">values</span>   
        <span class="c1"># Apply clipping</span>
        <span class="n">data_subset_clipped</span> <span class="o">=</span> <span class="n">data_subset</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">clipping</span><span class="p">)</span>
        <span class="c1"># log transform data</span>
        <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">data_subset_clipped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">data_subset_clipped</span><span class="p">)</span>
        <span class="c1"># identify the gates for the markers</span>
        <span class="n">r_gmm_gating</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">gmm_gating</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_subset_clipped</span><span class="p">)</span> 
        <span class="n">gates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">r_gmm_gating</span><span class="p">,</span> <span class="n">marker_to_gate</span><span class="p">))</span>     
        <span class="c1"># create a df with results</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">image_specific</span><span class="p">[</span><span class="n">image_specific</span><span class="o">.</span><span class="n">gate</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">marker_to_gate</span><span class="p">,</span> <span class="n">gates</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;gate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;markers&#39;</span><span class="p">]]</span>
        <span class="c1">#result[&#39;gate&#39;] = result[&#39;gate&#39;].fillna(result[&#39;markers&#39;].map(dict(zip(marker_to_gate, gates))))        </span>
        <span class="c1"># return</span>
        <span class="k">return</span> <span class="n">result</span>


    <span class="c1"># Create a list of image IDs that need to go through the GMM</span>
    <span class="n">gmm_images</span> <span class="o">=</span> <span class="n">gate_mapping</span><span class="p">[</span><span class="n">gate_mapping</span><span class="o">.</span><span class="n">gate</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">imageid</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>  

    <span class="c1"># Check if any image needs to pass through the GMM protocol</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gmm_images</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
        <span class="c1"># Create a list of adata that need to go through the GMM</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">adata_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">adata</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">adata_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">imageid</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gmm_images</span><span class="p">]</span>
        <span class="c1"># run function</span>
        <span class="n">r_gmm_gating_internal</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">gmm_gating_internal</span> <span class="p">(</span><span class="n">adata_subset</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> 
                                                               <span class="n">gate_mapping</span><span class="o">=</span><span class="n">gate_mapping</span><span class="p">,</span>
                                                               <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span> 
        <span class="n">all_gates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">r_gmm_gating_internal</span><span class="p">,</span> <span class="n">adata_list</span><span class="p">))</span>

        <span class="c1"># combine the results and merge with gate_mapping</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_gates</span><span class="p">)):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_gates</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
        <span class="c1"># use this to merge with gate_mapping</span>
        <span class="n">gate_mapping</span><span class="o">.</span><span class="n">gate</span> <span class="o">=</span> <span class="n">gate_mapping</span><span class="o">.</span><span class="n">gate</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">gate_mapping</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">markers</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">gate</span><span class="p">))))</span>


    <span class="c1"># Rescaling function</span>
    <span class="k">def</span> <span class="nf">data_scaler</span> <span class="p">(</span><span class="n">adata_subset</span><span class="p">,</span> <span class="n">gate_mapping</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Scaling Image &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">adata_subset</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">imageid</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="c1"># Organise data</span>
        <span class="n">data_subset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">adata_subset</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">adata_subset</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">adata_subset</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">data_subset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">data_subset</span><span class="p">)</span>
        <span class="c1"># subset markers in the subset</span>
        <span class="n">gate_mapping_sub</span> <span class="o">=</span> <span class="n">gate_mapping</span><span class="p">[</span><span class="n">gate_mapping</span><span class="p">[</span><span class="s1">&#39;imageid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">adata_subset</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">imageid</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="c1"># organise gates</span>
        <span class="k">def</span> <span class="nf">data_scaler_internal</span> <span class="p">(</span><span class="n">marker</span><span class="p">,</span> <span class="n">gate_mapping_sub</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Scaling &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">marker</span><span class="p">))</span>
            <span class="c1"># find the gate</span>
            <span class="n">moi</span> <span class="o">=</span> <span class="n">gate_mapping_sub</span><span class="p">[</span><span class="n">gate_mapping_sub</span><span class="o">.</span><span class="n">markers</span> <span class="o">==</span> <span class="n">marker</span><span class="p">][</span><span class="s1">&#39;gate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Find the closest value to the gate</span>
            <span class="n">absolute_val_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data_subset</span><span class="p">[</span><span class="n">marker</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">moi</span><span class="p">))</span>
            <span class="c1"># throw error if the array has nan values</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">absolute_val_array</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="s2">&quot;An exception occurred: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">marker</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; has nan values&#39;</span><span class="p">)</span>
            <span class="c1"># smallest diff</span>
            <span class="n">smallest_difference_index</span> <span class="o">=</span> <span class="n">absolute_val_array</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
            <span class="n">closest_element</span> <span class="o">=</span> <span class="n">data_subset</span><span class="p">[</span><span class="n">marker</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">smallest_difference_index</span><span class="p">]</span>

            <span class="c1"># rescale the data based on the identified gate</span>
            <span class="n">marker_study</span> <span class="o">=</span> <span class="n">data_subset</span><span class="p">[</span><span class="n">marker</span><span class="p">]</span>
            <span class="n">marker_study</span> <span class="o">=</span> <span class="n">marker_study</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># Find the index of the gate</span>
            <span class="c1"># account for 0</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">marker_study</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">gate_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">marker_study</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gate_index</span> <span class="o">=</span> <span class="n">marker_study</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">marker_study</span> <span class="o">==</span> <span class="n">closest_element</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Split into high and low groups</span>
            <span class="n">high</span> <span class="o">=</span> <span class="n">marker_study</span><span class="p">[</span><span class="n">gate_index</span><span class="p">:]</span>
            <span class="n">low</span> <span class="o">=</span> <span class="n">marker_study</span><span class="p">[:</span><span class="n">gate_index</span><span class="p">]</span>
            <span class="c1"># Prepare for scaling the high and low dataframes</span>
            <span class="n">scaler_high</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">scaler_low</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
            <span class="c1"># Scale it</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scaler_high</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">high</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">index</span> <span class="o">=</span> <span class="n">high</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scaler_low</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">low</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">index</span> <span class="o">=</span> <span class="n">low</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="c1"># Merge the high and low and resort it</span>
            <span class="n">scaled_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">l</span><span class="p">,</span><span class="n">h</span><span class="p">])</span>
            <span class="n">scaled_data</span> <span class="o">=</span> <span class="n">scaled_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">scaled_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)]</span>
            <span class="n">scaled_data</span> <span class="o">=</span> <span class="n">scaled_data</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">data_subset</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="c1">#scaled_data[scaled_data &gt; 0.5].count(axis=1).sum()</span>
            <span class="c1"># return</span>
            <span class="k">return</span> <span class="n">scaled_data</span>

        <span class="c1"># run internal function</span>
        <span class="n">r_data_scaler_internal</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">data_scaler_internal</span> <span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">gate_mapping_sub</span><span class="o">=</span><span class="n">gate_mapping_sub</span><span class="p">)</span> 
        <span class="n">scaled_subset</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">r_data_scaler_internal</span><span class="p">,</span> <span class="n">gate_mapping_sub</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>

        <span class="c1"># combine the results and merge with gate_mapping</span>
        <span class="n">scaled_subset_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scaled_subset</span><span class="p">)):</span>
            <span class="n">scaled_subset_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scaled_subset</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">scaled_subset_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">scaled_subset_result</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">scaled_subset_result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">gate_mapping_sub</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">values</span>
        <span class="c1">#scaled_subset_result[scaled_subset_result[&#39;CD3E&#39;] &gt; 0.5][&#39;CD3E&#39;].count(axis=1).sum()</span>

        <span class="c1"># return</span>
        <span class="k">return</span> <span class="n">scaled_subset_result</span>

    <span class="c1"># pass each dataset seperately</span>
    <span class="n">adata_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">imageid</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">imageid</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()]</span>

    <span class="c1"># Run the scaler function</span>
    <span class="n">r_data_scaler</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">data_scaler</span> <span class="p">(</span><span class="n">adata_subset</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">gate_mapping</span><span class="o">=</span><span class="n">gate_mapping</span><span class="p">)</span> 
    <span class="n">scaled_subset</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">r_data_scaler</span><span class="p">,</span> <span class="n">adata_list</span><span class="p">))</span>  

    <span class="c1"># combine the results and merge with gate_mapping</span>
    <span class="n">final_result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scaled_subset</span><span class="p">)):</span>
        <span class="n">final_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scaled_subset</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">final_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">final_result</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>

    <span class="c1"># reindex the final_results</span>
    <span class="n">final_result</span> <span class="o">=</span> <span class="n">final_result</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="c1"># save final gates</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;gates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gate_mapping</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;markers&#39;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;imageid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="c1">#.reset_index()</span>

    <span class="c1"># add to the anndata</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">final_result</span>

    <span class="c1"># return adata</span>
    <span class="k">return</span> <span class="n">adata</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>


  


  



                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://twitter.com/ajitjohnson_n" target="_blank" rel="noopener" title="Twitter" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.top", "search.highlight"], "search": "../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.b4d07000.min.js"></script>
      
    
  </body>
</html>